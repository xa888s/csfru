#!/bin/bash -e
IFS=$'\n'
while getopts a:o:i:*nrw option
do
    case "${option}"
    in
    a) APIKEY="${OPTARG}";;
    i) ALBUMDIR=$(realpath -e "${OPTARG}"); SPECTROGRAMSDIR="$ALBUMDIR/Spectrograms";;
    o) SPECTROGRAMSDIR=$(realpath "${OPTARG}/${ALBUMDIR##*/}");;
    n) NORMAL="true";;
    r) REMOVE="true";;
    w) WATERMARK="true";;
    *) 	    
    printf "Usage:\n"
    printf "csfru [options] -i ALBUMDIR\n"
    printf "\nOptions: "
    printf "\n-a PTPIMGAPIKEY"
    printf "\n-o SPECTROGRAMSDIR (if not specified will output in ALBUMDIR)"
    printf "\n-s (for small sized spectrograms)"
    printf "\n-r (remove after upload)"
    printf "\n-w [remove credit (link to the forum post)]\n"
    exit
    ;;
    esac
done

mkdir -p "$SPECTROGRAMSDIR" || exit
if [ ! $NORMAL ];
then
    mkdir -p "$SPECTROGRAMSDIR"/Zoomed "$SPECTROGRAMSDIR"/Normal
    for SONG in $(ls -v -1 "$ALBUMDIR"/*.flac);
    do
        SPECTROGRAMSONG="${SONG##*/}"
        SPECTROGRAM="${SPECTROGRAMSONG%.*}.png"
        sox "$SONG" -n remix 1 spectrogram -x 3000 -y 513 -z 120 -w Kaiser -o "$SPECTROGRAMSDIR"/Normal/"$SPECTROGRAM" -t "${SPECTROGRAMSONG%.*}" 
        sox "$SONG" -n remix 1 spectrogram -X 500 -y 1025 -z 120 -w Kaiser -S 1:00 -d 0:02 -o "$SPECTROGRAMSDIR"/Zoomed/"$SPECTROGRAM" -t "${SPECTROGRAMSONG%.*}" 
        echo "Spectrograms of "$SPECTROGRAMSONG" created."
    done
else
    for SONG in $(ls -v -1 "$ALBUMDIR"/*.flac);
    do
        SPECTROGRAMSONG="${SONG##*/}"
        SPECTROGRAM="${SPECTROGRAMSONG%.*}.png"
        sox "$SONG" -n spectrogram -o "$SPECTROGRAMSDIR"/"$SPECTROGRAM" -t "${SPECTROGRAMSONG%.*}" 
        echo "Spectrograms of "$SPECTROGRAMSONG" created."
    done
fi

if [ "$APIKEY" ]
then
    printf "Creating albumdescription.txt\n"
    printf "Tracklist:\n\n" > "$SPECTROGRAMSDIR/albumdescription.txt"
    for SONG in $(ls -v -1 "$ALBUMDIR"/*.flac);
    do
	SONGNAME="${SONG##*/}"
	SONGNAMEFIXED=$(echo "${SONGNAME%.*}" | sed 's/%/%%/g')
        printf "$SONGNAMEFIXED" >> "$SPECTROGRAMSDIR/albumdescription.txt"
	SONGLENGTH=$(ffmpeg -i "$SONG" 2>&1 | grep Duration | sed -e "s/\,.*//" -e "s/^[^:]*://" -e "s/^[^:]*://" | cut -f 1 -d'.')
        printf " $SONGLENGTH\n" >> "$SPECTROGRAMSDIR/albumdescription.txt" 
    done
    xclip -sel c < "$SPECTROGRAMSDIR/albumdescription.txt"
    printf "Copied albumdescription.txt to clipboard\n"
    read -p "Press enter when done pasting." input
    xsel -bc
    if [ $NORMAL ];
    then
        printf "[spoiler=Spectrograms]" > "$SPECTROGRAMSDIR/releasedescription.txt"
	for SPECTROGRAM in $(ls -v -1 "$SPECTROGRAMSDIR"/*.png);
        do
            SONGNAME="${SPECTROGRAM##*/}"
            echo "Uploading "${SONGNAME%.*}""
            if [[ "$SPECTROGRAM" == *","* ]]
            then
                SPECTROGRAMLINK=$(curl -F "file-upload[0]=@\"$SPECTROGRAM\"" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
            else
                SPECTROGRAMLINK=$(curl -F "file-upload[0]=@$(realpath "$SPECTROGRAM")" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
            fi
            echo "${SONGNAME%.*} has been uploaded."
            echo "${SONGNAME%.*}" >> "$SPECTROGRAMSDIR/releasedescription.txt"
            printf "[img]$SPECTROGRAMLINK[/img]\n\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
        done
        printf "[/spoiler]\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
        xclip -sel c < "$SPECTROGRAMSDIR/releasedescription.txt"
        printf "Copied releasedescription.txt to clipboard!\n"
    else
        printf "[spoiler=Spectrograms]" > "$SPECTROGRAMSDIR/releasedescription.txt"
        for SONG in $(ls -v -1 "$ALBUMDIR"/*.flac);
        do
	    SPECTROGRAMNORMALPATH="$SPECTROGRAMSDIR/Normal/${SONGNAME%.*}.png"
	    SPECTROGRAMZOOMEDPATH="$SPECTROGRAMSDIR/Zoomed/${SONGNAME%.*}.png"
            SONGNAME="${SONG##*/}"
            echo "Uploading ${SONGNAME%.*}"
	    if [[ "$SONG" == *","* ]]
            then
                SPECTROGRAMNORMALLINK=$(curl -F "file-upload[0]=@\"$SPECTROGRAMNORMALPATH\"" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
                echo "${SONGNAME%.*} (Normal) has been uploaded."
		echo "${SONGNAME%.*} (Normal)" >> "$SPECTROGRAMSDIR/releasedescription.txt"
                printf "[img]$SPECTROGRAMNORMALLINK[/img]\n\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
                SPECTROGRAMZOOMEDLINK=$(curl -F "file-upload[0]=@\"$SPECTROGRAMZOOMEDPATH\"" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
		echo "${SONGNAME%.*} (Zoomed) has been uploaded."
		echo "${SONGNAME%.*} (Zoomed)" >> "$SPECTROGRAMSDIR/releasedescription.txt"
                printf "[img]$SPECTROGRAMZOOMEDLINK[/img]\n\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
            else
                SPECTROGRAMNORMALLINK=$(curl -F "file-upload[0]=@$(realpath "$SPECTROGRAMNORMALPATH")" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
                echo "${SONGNAME%.*} (Normal) has been uploaded."
		echo "${SONGNAME%.*} (Normal)" >> "$SPECTROGRAMSDIR/releasedescription.txt"
                printf "[img]$SPECTROGRAMNORMALLINK[/img]\n\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
                SPECTROGRAMZOOMEDLINK=$(curl -F "file-upload[0]=@$(realpath "$SPECTROGRAMZOOMEDPATH")" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
		echo "${SONGNAME%.*} (Zoomed) has been uploaded."
		echo "${SONGNAME%.*} (Zoomed)" >> "$SPECTROGRAMSDIR/releasedescription.txt"
                printf "[img]$SPECTROGRAMZOOMEDLINK[/img]\n\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
            fi
        done
        printf "[/spoiler]\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
        if [ ! "$WATERMARK" ]
        then
            printf "\nThese spectrals were generated using [url=https://redacted.ch/forums.php?action=viewthread&threadid=33769]csfru[/url]\n" >> "$SPECTROGRAMSDIR/releasedescription.txt"
        fi
        xclip -sel c < "$SPECTROGRAMSDIR/releasedescription.txt"
        printf "Copied releasedescription.txt to clipboard!\n"
	
    fi
    if [ "$REMOVE" ]
    then
	read -p "Press enter when done pasting." input
	xsel -bc
	printf "Removing $SPECTROGRAMSDIR\n"
        rm -rf "$SPECTROGRAMSDIR"/*
        rmdir "$SPECTROGRAMSDIR"
    fi
fi
