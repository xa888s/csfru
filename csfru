#!/bin/sh -e
while getopts a:o:i:*sr option
do
    case "${option}"
    in
    a) APIKEY="${OPTARG}";;
    i) ALBUMDIR=$(realpath -e "${OPTARG}"); SPECTROGRAMSDIR="$ALBUMDIR/Spectrograms";;
    o) SPECTROGRAMSDIR=$(realpath "${OPTARG}/${ALBUMDIR##*/}");;
    s) SMALL="true";;
    r) REMOVE="true";;
    *) 	    
    echo "Usage: "
    echo "csfru [options] -i ALBUMDIR"
    echo " "
    echo "Options: "
    echo "-a PTPIMGAPIKEY"
    echo "-o SPECTROGRAMSDIR (if not specified will output in ALBUMDIR)"
    echo "-u (whether to upload or not)"
    echo "-s (for small sized spectrograms)"
    echo "-r (remove after upload)"
    exit
    ;;
    esac
done

mkdir -p "$SPECTROGRAMSDIR" || exit
for SONG in "$ALBUMDIR"/*.flac;
do
    SPECTROGRAMSONG="${SONG##*/}"
    SPECTROGRAM="${SPECTROGRAMSONG%.*}.png"
    if [ "$SMALL" ]
    then
        sox "$SONG" -n spectrogram -o "$SPECTROGRAMSDIR/$SPECTROGRAM"
    else
        sox "$SONG" -n remix 1 spectrogram -x 3000 -y 513 -z 120 -w Kaiser -o "$SPECTROGRAMSDIR/$SPECTROGRAM"
    fi
    echo "Spectrogram of $SPECTROGRAMSONG created."
done

if [ "$APIKEY" ]
then
    echo "Creating albumdescription.txt"
    echo "Tracklist: " > "$SPECTROGRAMSDIR/albumdescription.txt"
    echo " " >> "$SPECTROGRAMSDIR/albumdescription.txt"
    for SPECTROGRAM in "$SPECTROGRAMSDIR"/*.png;
    do
	SPECTROGRAMNAME="${SPECTROGRAM##*/}"
        echo "${SPECTROGRAMNAME%.*}" >> "$SPECTROGRAMSDIR/albumdescription.txt"
    done
    xclip -sel c < "$SPECTROGRAMSDIR/albumdescription.txt"
    echo "Copied albumdescription.txt to clipboard"
    read -p "Press enter when done pasting." input
    xsel -bc
    printf "[spoiler=Spectrograms]" > "$SPECTROGRAMSDIR/releasedescription.txt"
    for SPECTROGRAM in "$SPECTROGRAMSDIR"/*.png;
    do
	SONGNAME="${SPECTROGRAM##*/}"
        echo "Uploading ${SONGNAME%.*}"
        if [[ "$SPECTROGRAM" == *","* ]]
        then
            SPECTROGRAMLINK=$(curl -F "file-upload[0]=@\"$SPECTROGRAM\"" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
        else
            SPECTROGRAMLINK=$(curl -F "file-upload[0]=@$(realpath "$SPECTROGRAM")" -F api_key="$APIKEY" "https://ptpimg.me/upload.php" | awk -F ":|," '!(NR%4){print p$2}{p=$2}'| sed 's/^.*"\(.*\)" "\(.*\)".*$/https:\/\/ptpimg.me\/\1.\2/')
        fi
        echo "${SONGNAME%.*} has been uploaded."
        echo "${SONGNAME%.*}" >> "$SPECTROGRAMSDIR/releasedescription.txt"
        echo "[img]$SPECTROGRAMLINK[/img]" >> "$SPECTROGRAMSDIR/releasedescription.txt"
        echo " " >> "$SPECTROGRAMSDIR/releasedescription.txt"
    done
    echo "[/spoiler]" >> "$SPECTROGRAMSDIR/releasedescription.txt"
    xclip -sel c < "$SPECTROGRAMSDIR/releasedescription.txt"
    echo "Copied releasedescription.txt to clipboard!"
    if [ "$REMOVE" ]
    then
	read -p "Press enter when done pasting." input
	xsel -bc
	echo "Removing $SPECTROGRAMSDIR"
        rm "$SPECTROGRAMSDIR"/*
        rmdir "$SPECTROGRAMSDIR"
    fi
fi
